<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('Pago Seguro | EcoMaxTienda')">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pago Seguro | EcoMaxTienda</title>
</head>
<body class="eco-bg">
    <div th:replace="fragments/client-navbar :: client-navbar"></div>
    <main class="container my-5">
        <div class="row">
            <div class="col-12">
                <div class="d-flex align-items-center mb-4">
                    <i class="bi bi-credit-card text-success me-3 fs-2"></i>
                    <h1 class="fw-bold text-success mb-0">Procesar Pago</h1>
                </div>
                <p class="lead mb-5">Completa tu compra de manera segura y confiable.</p>
            </div>
        </div>

        <div class="row">
            <!-- Formulario de pago -->
            <div class="col-lg-8">
                <!-- Información de envío -->
                <div class="client-modern-card">
                    <div class="client-card-header">
                        <h5 class="mb-0"><i class="bi bi-truck me-2"></i>Información de Envío</h5>
                    </div>
                    <div class="client-card-body">
                        <form id="shippingForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="firstName" class="client-form-label">Nombre *</label>
                                    <input type="text" class="client-form-control" id="firstName" placeholder="Tu nombre" required
                                           th:value="${usuario?.nombre ?: ''}" th:placeholder="${usuario?.nombre ?: 'Tu nombre'}">
                                </div>
                                <div class="col-md-6">
                                    <label for="lastName" class="client-form-label">Apellidos *</label>
                                    <input type="text" class="client-form-control" id="lastName" placeholder="Tus apellidos" required>
                                </div>
                                <div class="col-12">
                                    <label for="email" class="client-form-label">Correo Electrónico *</label>                                    <input type="email" class="client-form-control" id="email" placeholder="tu@email.com" required
                                           th:value="${usuario?.email ?: ''}" th:placeholder="${usuario?.email ?: 'tu@email.com'}">
                                </div>
                                <div class="col-md-6">
                                    <label for="phone" class="client-form-label">Teléfono *</label>
                                    <input type="tel" class="client-form-control" id="phone" placeholder="+51 999 999 999" required
                                           th:value="${usuario?.telefono ?: ''}" th:placeholder="${usuario?.telefono ?: '+51 999 999 999'}">
                                </div>
                                <div class="col-md-6">
                                    <label for="country" class="form-label fw-bold">País *</label>
                                    <select class="form-select" id="country" required>
                                        <option value="">Selecciona tu país</option>
                                        <option value="PE" selected>Perú</option>
                                        <option value="PE" selected>Perú</option>
                                        <option value="CO">Colombia</option>
                                        <option value="MX">México</option>
                                        <option value="AR">Argentina</option>
                                        <option value="CL">Chile</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label for="address" class="form-label fw-bold">Dirección *</label>
                                    <input type="text" class="form-control" id="address" placeholder="Av. Principal 123" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="city" class="form-label fw-bold">Ciudad *</label>
                                    <input type="text" class="form-control" id="city" placeholder="Lima" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="state" class="form-label fw-bold">Región/Estado *</label>
                                    <input type="text" class="form-control" id="state" placeholder="Lima" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="zipCode" class="form-label fw-bold">Código Postal *</label>
                                    <input type="text" class="form-control" id="zipCode" placeholder="15001" required>
                                </div>
                                <div class="col-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="saveAddress">
                                        <label class="form-check-label" for="saveAddress">
                                            Guardar esta dirección para futuras compras
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Información de pago -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-credit-card-2-front me-2"></i>Método de Pago</h5>
                    </div>
                    <div class="card-body">
                        <!-- Opciones de pago -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="form-check payment-option">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="creditCard" value="creditCard" checked>
                                    <label class="form-check-label w-100" for="creditCard">
                                        <div class="card border-2 h-100">
                                            <div class="card-body text-center">
                                                <i class="bi bi-credit-card text-primary fs-3"></i>
                                                <div class="fw-bold mt-2">Tarjeta de Crédito</div>
                                                <small class="text-muted">Visa, Mastercard, American Express</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check payment-option">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="paypal" value="paypal">
                                    <label class="form-check-label w-100" for="paypal">
                                        <div class="card border-2 h-100">
                                            <div class="card-body text-center">
                                                <i class="bi bi-paypal text-primary fs-3"></i>
                                                <div class="fw-bold mt-2">PayPal</div>
                                                <small class="text-muted">Pago rápido y seguro</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check payment-option">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="bankTransfer" value="bankTransfer">
                                    <label class="form-check-label w-100" for="bankTransfer">
                                        <div class="card border-2 h-100">
                                            <div class="card-body text-center">
                                                <i class="bi bi-bank text-primary fs-3"></i>
                                                <div class="fw-bold mt-2">Transferencia</div>
                                                <small class="text-muted">Depósito bancario</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Formulario de tarjeta de crédito -->
                        <div id="creditCardForm">
                            <form id="paymentForm">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="cardNumber" class="form-label fw-bold">Número de Tarjeta *</label>
                                        <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" 
                                               maxlength="19" required>
                                    </div>
                                    <div class="col-12">
                                        <label for="cardName" class="form-label fw-bold">Nombre en la Tarjeta *</label>
                                        <input type="text" class="form-control" id="cardName" placeholder="Como aparece en la tarjeta" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="expiryDate" class="form-label fw-bold">Fecha de Vencimiento *</label>
                                        <input type="text" class="form-control" id="expiryDate" placeholder="MM/AA" maxlength="5" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="cvv" class="form-label fw-bold">
                                            CVV *
                                            <i class="bi bi-question-circle" data-bs-toggle="tooltip" 
                                               title="Código de 3 dígitos en el reverso de tu tarjeta"></i>
                                        </label>
                                        <input type="text" class="form-control" id="cvv" placeholder="123" maxlength="4" required>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Información de PayPal -->
                        <div id="paypalForm" class="payment-form-hidden">
                            <div class="text-center p-4">
                                <i class="bi bi-paypal display-1 text-primary"></i>
                                <h5 class="mt-3">Serás redirigido a PayPal para completar el pago</h5>
                                <p class="text-muted">PayPal es un método de pago seguro y confiable</p>
                            </div>
                        </div>

                        <!-- Información de transferencia -->
                        <div id="bankTransferForm" class="payment-form-hidden">
                            <div class="alert alert-info">
                                <h6><i class="bi bi-info-circle me-2"></i>Información para Transferencia Bancaria</h6>
                                <p class="mb-2"><strong>Banco:</strong> Banco de Crédito del Perú (BCP)</p>
                                <p class="mb-2"><strong>Cuenta Corriente:</strong> 1234-5678-9012-3456</p>
                                <p class="mb-2"><strong>Titular:</strong> EcoMaxTienda S.A.C.</p>
                                <p class="mb-0"><strong>Referencia:</strong> <span class="text-primary fw-bold">ECO-2024-001</span></p>
                            </div>
                            <p class="text-muted small">
                                Una vez realizada la transferencia, envía el comprobante a <strong>pagos@ecomaxtienda.com</strong> 
                                para procesar tu pedido.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Términos y condiciones -->
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="acceptTerms" required>
                            <label class="form-check-label" for="acceptTerms">
                                Acepto los <a href="#" class="text-success">términos y condiciones</a> de EcoMaxTienda 
                                y la <a href="#" class="text-success">política de privacidad</a>
                            </label>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="newsletter">
                            <label class="form-check-label" for="newsletter">
                                Quiero recibir ofertas especiales y noticias sobre productos eco-amigables
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumen del pedido -->
            <div class="col-lg-4">
                <div class="card shadow-sm border-0 sticky-top cart-summary-card">
                    <div class="card-header bg-light border-0">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-receipt me-2"></i>Resumen del Pedido</h5>
                    </div>
                    <div class="card-body">
                        <!-- Productos -->
                        <div class="mb-3">
                            <h6 class="fw-bold">Productos (4 artículos):</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="small">Eco Kit Hogar x2</span>
                                <span class="small">S/ 117.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="small">Shampoo Natural x1</span>
                                <span class="small">S/ 40.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="small">Botella Reutilizable x1</span>
                                <span class="small">S/ 50.00</span>
                            </div>
                        </div>

                        <hr>

                        <!-- Cálculos -->
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span>S/ 248.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Envío:</span>
                            <span class="text-success fw-bold">GRATIS</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Descuento Eco-Friendly:</span>
                            <span class="text-success">-S/ 12.40</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>IGV (18%):</span>
                            <span>S/ 42.40</span>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between mb-4">
                            <h5 class="fw-bold">Total a Pagar:</h5>
                            <h5 class="fw-bold text-success">S/ 278.00</h5>
                        </div>

                        <!-- Botón de procesar pago -->
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg" onclick="processPayment()" id="processPaymentBtn">
                                <i class="bi bi-shield-check me-2"></i>Procesar Pago Seguro
                            </button>
                            <a href="/client/carrito" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Volver al Carrito
                            </a>
                        </div>

                        <!-- Garantías de seguridad -->
                        <div class="mt-4 text-center">
                            <div class="row g-2">
                                <div class="col-4">
                                    <i class="bi bi-shield-check text-success fs-5"></i>
                                    <div class="small text-muted">Pago Seguro</div>
                                </div>
                                <div class="col-4">
                                    <i class="bi bi-truck text-success fs-5"></i>
                                    <div class="small text-muted">Envío Gratis</div>
                                </div>
                                <div class="col-4">
                                    <i class="bi bi-arrow-repeat text-success fs-5"></i>
                                    <div class="small text-muted">Devoluciones</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div th:replace="fragments/footer :: footer"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Formatear número de tarjeta
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            if (formattedValue.length > 19) formattedValue = formattedValue.substr(0, 19);
            this.value = formattedValue;
        });

        // Formatear fecha de vencimiento
        document.getElementById('expiryDate').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            this.value = value;
        });

        // Solo números para CVV
        document.getElementById('cvv').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // Cambiar formulario según método de pago
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const creditCardForm = document.getElementById('creditCardForm');
                const paypalForm = document.getElementById('paypalForm');
                const bankTransferForm = document.getElementById('bankTransferForm');
                const processBtn = document.getElementById('processPaymentBtn');

                // Ocultar todos los formularios
                creditCardForm.style.display = 'none';
                paypalForm.style.display = 'none';
                bankTransferForm.style.display = 'none';

                // Mostrar el formulario correspondiente
                if (this.value === 'creditCard') {
                    creditCardForm.style.display = 'block';
                    processBtn.innerHTML = '<i class="bi bi-shield-check me-2"></i>Procesar Pago Seguro';
                } else if (this.value === 'paypal') {
                    paypalForm.style.display = 'block';
                    processBtn.innerHTML = '<i class="bi bi-paypal me-2"></i>Pagar con PayPal';
                } else if (this.value === 'bankTransfer') {
                    bankTransferForm.style.display = 'block';
                    processBtn.innerHTML = '<i class="bi bi-bank me-2"></i>Confirmar Transferencia';
                }

                // Actualizar estilos de las tarjetas de pago
                document.querySelectorAll('.payment-option .card').forEach(card => {
                    card.classList.remove('border-success');
                });
                this.closest('.payment-option').querySelector('.card').classList.add('border-success');
            });
        });        // Procesar pago
        function processPayment() {
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const acceptTerms = document.getElementById('acceptTerms').checked;

            if (!acceptTerms) {
                alert('Debes aceptar los términos y condiciones para continuar.');
                return;
            }

            // Validar formularios según el método de pago
            if (paymentMethod === 'creditCard') {
                if (!validateCreditCardForm()) {
                    return;
                }
            }

            if (!validateShippingForm()) {
                return;
            }

            // Simular procesamiento
            const processBtn = document.getElementById('processPaymentBtn');
            const originalText = processBtn.innerHTML;
            
            processBtn.disabled = true;
            processBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';

            // Simular procesamiento del pago (3 segundos)
            setTimeout(function() {
                // Mostrar modal de éxito
                showPaymentSuccessModal();
            }, 3000);
        }

        // Mostrar modal de éxito de pago
        function showPaymentSuccessModal() {
            // Crear modal dinámicamente
            const modalHtml = `
                <div class="modal fade" id="paymentSuccessModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow">
                            <div class="modal-body text-center p-5">
                                <div class="mb-4">
                                    <i class="bi bi-check-circle-fill text-success payment-success-icon"></i>
                                </div>
                                <h3 class="fw-bold text-success mb-3">¡Pago Exitoso!</h3>
                                <p class="lead mb-4">Tu pago ha sido procesado correctamente.<br>Tu pedido está siendo preparado.</p>
                                
                                <div class="alert alert-success border-0 mb-4">
                                    <div class="fw-bold mb-2">
                                        <i class="bi bi-receipt me-2"></i>Número de Pedido: <strong>ECO-2024-001234</strong>
                                    </div>
                                    <div class="small">Guarda este número para rastrear tu pedido</div>
                                </div>
                                  <div class="countdown-container mb-4">
                                    <div class="progress mb-2 redirect-progress">
                                        <div class="progress-bar bg-success progress-bar-animated redirect-progress-bar" role="progressbar" 
                                             aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" id="redirectProgress"></div>
                                    </div>
                                    <p class="small text-muted mb-0">
                                        Redirigiendo al área de cliente en <span id="countdown" class="fw-bold text-success">5</span> segundos...
                                    </p>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" onclick="redirectToHome()">
                                        <i class="bi bi-house me-2"></i>Ir a Mi Área Ahora
                                    </button>
                                    <button class="btn btn-outline-success" onclick="viewOrderDetails()">
                                        <i class="bi bi-eye me-2"></i>Ver Detalles del Pedido
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Agregar modal al DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('paymentSuccessModal'));
            modal.show();
            
            // Iniciar countdown
            startRedirectCountdown();
        }

        // Iniciar countdown para redirección
        function startRedirectCountdown() {
            let timeLeft = 5;
            const countdownElement = document.getElementById('countdown');
            const progressBar = document.getElementById('redirectProgress');
            
            const timer = setInterval(function() {
                timeLeft--;
                countdownElement.textContent = timeLeft;
                
                // Actualizar barra de progreso
                const progressWidth = (timeLeft / 5) * 100;
                progressBar.style.width = progressWidth + '%';
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    redirectToHome();
                }
            }, 1000);
        }

        // Redireccionar al área de cliente
        function redirectToHome() {
            // Guardar información del pedido en localStorage para mostrar en home
            const orderInfo = {
                orderNumber: 'ECO-2024-001234',
                orderDate: new Date().toISOString(),
                total: 'S/ 278.00',
                status: 'confirmed',
                items: 4
            };
            localStorage.setItem('recentOrder', JSON.stringify(orderInfo));
            
            // Redireccionar
            window.location.href = '/client/home?orderSuccess=true';
        }

        // Ver detalles del pedido
        function viewOrderDetails() {
            window.location.href = '/client/confirmacion';
        }

        // Validar formulario de tarjeta de crédito
        function validateCreditCardForm() {
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const cardName = document.getElementById('cardName').value;
            const expiryDate = document.getElementById('expiryDate').value;
            const cvv = document.getElementById('cvv').value;

            if (cardNumber.length < 16) {
                alert('Ingresa un número de tarjeta válido.');
                return false;
            }

            if (!cardName.trim()) {
                alert('Ingresa el nombre que aparece en la tarjeta.');
                return false;
            }

            if (expiryDate.length < 5) {
                alert('Ingresa una fecha de vencimiento válida.');
                return false;
            }

            if (cvv.length < 3) {
                alert('Ingresa un CVV válido.');
                return false;
            }

            return true;
        }

        // Validar formulario de envío
        function validateShippingForm() {
            const requiredFields = ['firstName', 'lastName', 'email', 'phone', 'country', 'address', 'city', 'state', 'zipCode'];
            
            for (let fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    alert(`Por favor, completa el campo: ${field.previousElementSibling.textContent}`);
                    field.focus();
                    return false;
                }
            }

            // Validar email
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Ingresa un correo electrónico válido.');
                return false;
            }

            return true;
        }

        // Inicializar tooltips
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Marcar la primera opción de pago como seleccionada
            document.querySelector('.payment-option .card').classList.add('border-success');
        });
    </script>
</body>
</html>
