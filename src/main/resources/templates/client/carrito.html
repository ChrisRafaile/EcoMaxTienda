<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('Carrito de Compras | EcoMaxTienda')">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Carrito de Compras | EcoMaxTienda</title>
</head>
<body class="eco-bg">
    <div th:replace="fragments/navbar :: navbar"></div>
    <main class="container my-5">
        <div class="row">
            <div class="col-12">
                <div class="d-flex align-items-center mb-4">
                    <i class="bi bi-cart-fill text-success me-3 fs-2"></i>
                    <h1 class="fw-bold text-success mb-0">Mi Carrito de Compras</h1>
                </div>
                <p class="lead mb-5">Revisa tus productos seleccionados antes de proceder al pago.</p>
            </div>
        </div>

        <div class="row">
            <!-- Lista de productos en el carrito -->
            <div class="col-lg-8">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-bag-check me-2"></i><span class="text-white">Productos en tu Carrito</span></h5>
                    </div>
                    <div class="card-body p-0">
                        <!-- Producto 1 -->
                        <div class="p-4 border-bottom">
                            <div class="row align-items-center">
                                <div class="col-md-2 text-center">
                                    <i class="bi bi-box-seam display-5 text-success"></i>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="fw-bold mb-1">Eco Kit Hogar</h6>
                                    <p class="text-muted small mb-0">Kit completo de productos ecológicos para el hogar</p>
                                    <span class="badge bg-success">Eco-Friendly</span>
                                </div>
                                <div class="col-md-2">
                                    <label class="fw-bold small text-muted">Precio</label>
                                    <div class="fw-bold text-success">$17.50</div>
                                </div>                                <div class="col-md-2">
                                    <label for="quantity1" class="fw-bold small text-muted">Cantidad</label>
                                    <div class="input-group input-group-sm">
                                        <button class="btn btn-outline-secondary" type="button" onclick="decreaseQuantity(1)" aria-label="Disminuir cantidad" title="Disminuir cantidad">-</button>
                                        <input type="number" class="form-control text-center" id="quantity1" value="2" min="1" readonly aria-label="Cantidad del producto">
                                        <button class="btn btn-outline-secondary" type="button" onclick="increaseQuantity(1)" aria-label="Aumentar cantidad" title="Aumentar cantidad">+</button>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <label class="fw-bold small text-muted">Subtotal</label>
                                    <div class="fw-bold text-success" id="subtotal1">$35.00</div>
                                </div>                                <div class="col-md-1">
                                    <button class="btn btn-outline-danger btn-sm" onclick="removeItem(1)" aria-label="Eliminar producto del carrito" title="Eliminar producto">
                                        <i class="bi bi-trash" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Producto 2 -->
                        <div class="p-4 border-bottom">
                            <div class="row align-items-center">
                                <div class="col-md-2 text-center">
                                    <i class="bi bi-box-seam display-5 text-success"></i>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="fw-bold mb-1">Shampoo Natural</h6>
                                    <p class="text-muted small mb-0">Shampoo orgánico libre de químicos dañinos</p>
                                    <span class="badge bg-success">Orgánico</span>
                                </div>
                                <div class="col-md-2">
                                    <label class="fw-bold small text-muted">Precio</label>
                                    <div class="fw-bold text-success">$12.00</div>
                                </div>                                <div class="col-md-2">
                                    <label for="quantity2" class="fw-bold small text-muted">Cantidad</label>
                                    <div class="input-group input-group-sm">
                                        <button class="btn btn-outline-secondary" type="button" onclick="decreaseQuantity(2)" aria-label="Disminuir cantidad" title="Disminuir cantidad">-</button>
                                        <input type="number" class="form-control text-center" id="quantity2" value="1" min="1" readonly aria-label="Cantidad del producto">
                                        <button class="btn btn-outline-secondary" type="button" onclick="increaseQuantity(2)" aria-label="Aumentar cantidad" title="Aumentar cantidad">+</button>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <label class="fw-bold small text-muted">Subtotal</label>
                                    <div class="fw-bold text-success" id="subtotal2">$12.00</div>
                                </div>                                <div class="col-md-1">
                                    <button class="btn btn-outline-danger btn-sm" onclick="removeItem(2)" aria-label="Eliminar producto del carrito" title="Eliminar producto">
                                        <i class="bi bi-trash" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Producto 3 -->
                        <div class="p-4 border-bottom">
                            <div class="row align-items-center">
                                <div class="col-md-2 text-center">
                                    <i class="bi bi-droplet-half display-5 text-primary"></i>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="fw-bold mb-1">Botella Reutilizable</h6>
                                    <p class="text-muted small mb-0">Botella de acero inoxidable libre de BPA</p>
                                    <span class="badge bg-success">Reutilizable</span>
                                </div>
                                <div class="col-md-2">
                                    <label class="fw-bold small text-muted">Precio</label>
                                    <div class="fw-bold text-success">$15.00</div>
                                </div>                                <div class="col-md-2">
                                    <label for="quantity3" class="fw-bold small text-muted">Cantidad</label>
                                    <div class="input-group input-group-sm">
                                        <button class="btn btn-outline-secondary" type="button" onclick="decreaseQuantity(3)" aria-label="Disminuir cantidad" title="Disminuir cantidad">-</button>
                                        <input type="number" class="form-control text-center" id="quantity3" value="1" min="1" readonly aria-label="Cantidad del producto">
                                        <button class="btn btn-outline-secondary" type="button" onclick="increaseQuantity(3)" aria-label="Aumentar cantidad" title="Aumentar cantidad">+</button>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <label class="fw-bold small text-muted">Subtotal</label>
                                    <div class="fw-bold text-success" id="subtotal3">$15.00</div>
                                </div>                                <div class="col-md-1">
                                    <button class="btn btn-outline-danger btn-sm" onclick="removeItem(3)" 
                                            aria-label="Eliminar producto del carrito" title="Eliminar producto">
                                        <i class="bi bi-trash" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Botón para continuar comprando -->
                        <div class="p-4">
                            <a href="/client/catalogo" class="btn btn-outline-success">
                                <i class="bi bi-arrow-left me-2"></i>Continuar Comprando
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumen del pedido -->
            <div class="col-lg-4">
                <div class="card shadow-sm border-0 sticky-top cart-summary-card">
                    <div class="card-header bg-light border-0">
                        <h5 class="mb-0 fw-bold text-dark"><i class="bi bi-receipt me-2"></i>Resumen del Pedido</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-dark">Subtotal (4 productos):</span>
                            <span id="cartSubtotal" class="text-dark">$62.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-dark">Envío:</span>
                            <span class="text-success fw-bold">GRATIS</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-dark">Descuento Eco-Friendly:</span>
                            <span class="text-success">-$3.10</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-4">
                            <h5 class="fw-bold text-dark">Total:</h5>
                            <h5 class="fw-bold text-success" id="cartTotal">$58.90</h5>
                        </div>

                        <!-- Cupón de descuento -->
                        <div class="mb-3">
                            <label class="form-label fw-bold text-dark">Código de Cupón:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Ingresa tu cupón" id="couponCode">
                                <button class="btn btn-outline-success" type="button" onclick="applyCoupon()">Aplicar</button>
                            </div>
                            <div class="text-success small mt-1 coupon-message" id="couponMessage">
                                <i class="bi bi-check-circle me-1"></i>Cupón aplicado correctamente
                            </div>
                        </div>

                        <!-- Botón de proceder al pago -->
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg" onclick="proceedToPayment()">
                                <i class="bi bi-credit-card me-2"></i>Proceder al Pago
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearCart()">
                                <i class="bi bi-trash me-2"></i>Vaciar Carrito
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Información adicional -->
                <div class="card shadow-sm border-0 mt-4">
                    <div class="card-body">
                        <h6 class="fw-bold text-success mb-3">
                            <i class="bi bi-shield-check me-2"></i>Compra Segura
                        </h6>
                        <ul class="list-unstyled small">
                            <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Envío gratuito en pedidos superiores a $50</li>
                            <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Garantía de devolución de 30 días</li>
                            <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Pago 100% seguro</li>
                            <li class="mb-0"><i class="bi bi-check-circle text-success me-2"></i>Productos eco-amigables certificados</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>    </main>
    
    <!-- Modal de confirmación del carrito -->
    <div class="modal fade" id="cartConfirmationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 bg-success text-white">
                <div class="modal-body text-center p-5">
                    <div class="success-animation mb-4">
                        <i class="bi bi-check-circle-fill success-icon"></i>
                    </div>
                    <h4 class="fw-bold mb-3">¡Carrito Registrado Exitosamente!</h4>
                    <p class="mb-4">Tu carrito ha sido procesado y serás redirigido a la página de pago en unos segundos.</p>                    <div class="progress bg-light mb-3 redirect-progress">
                        <div class="progress-bar bg-white redirect-progress-bar" role="progressbar" 
                             id="redirectProgress" aria-label="Progreso de redirección" 
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <p class="small mb-0">Redirigiendo en <span id="countdown">5</span> segundos...</p>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="fragments/footer :: footer"></div>    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Agregar estilos CSS para animaciones
        const style = document.createElement('style');
        style.textContent = `
            @keyframes bounce {
                0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                40% { transform: translateY(-15px); }
                60% { transform: translateY(-8px); }
            }
            
            .success-animation {
                animation: bounce 0.6s ease-in-out;
            }
            
            .product-card {
                transition: all 0.3s ease;
            }
            
            .product-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
        `;
        document.head.appendChild(style);

        // Precios base de los productos
        const productPrices = {
            1: 17.50, // Eco Kit Hogar
            2: 12.00, // Shampoo Natural
            3: 15.00  // Botella Reutilizable
        };

        // Función para aumentar cantidad
        function increaseQuantity(productId) {
            const quantityInput = document.getElementById(`quantity${productId}`);
            let currentQuantity = parseInt(quantityInput.value);
            currentQuantity++;
            quantityInput.value = currentQuantity;
            updateSubtotal(productId, currentQuantity);
            updateCartTotals();
        }

        // Función para disminuir cantidad
        function decreaseQuantity(productId) {
            const quantityInput = document.getElementById(`quantity${productId}`);
            let currentQuantity = parseInt(quantityInput.value);
            if (currentQuantity > 1) {
                currentQuantity--;
                quantityInput.value = currentQuantity;
                updateSubtotal(productId, currentQuantity);
                updateCartTotals();
            }
        }

        // Función para actualizar subtotal del producto
        function updateSubtotal(productId, quantity) {
            const price = productPrices[productId];
            const subtotal = price * quantity;
            document.getElementById(`subtotal${productId}`).textContent = `$${subtotal.toFixed(2)}`;
        }

        // Función para actualizar totales del carrito
        function updateCartTotals() {
            let subtotal = 0;
            let totalItems = 0;

            for (let productId in productPrices) {
                const quantity = parseInt(document.getElementById(`quantity${productId}`).value);
                const price = productPrices[productId];
                subtotal += price * quantity;
                totalItems += quantity;
            }

            const discount = subtotal * 0.05; // 5% de descuento eco-friendly
            const total = subtotal - discount;

            document.getElementById('cartSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('cartTotal').textContent = `$${total.toFixed(2)}`;
            
            // Actualizar número de productos
            const summaryText = document.querySelector('.card-body .d-flex span');
            if (summaryText) {
                summaryText.textContent = `Subtotal (${totalItems} productos):`;
            }
        }

        // Función para eliminar producto del carrito
        function removeItem(productId) {
            if (confirm('¿Estás seguro de que deseas eliminar este producto del carrito?')) {
                const productRow = document.getElementById(`quantity${productId}`).closest('.p-4');
                productRow.remove();
                delete productPrices[productId];
                updateCartTotals();
                
                // Si no quedan productos, mostrar mensaje
                if (Object.keys(productPrices).length === 0) {
                    showEmptyCart();
                }
            }
        }

        // Función para aplicar cupón
        function applyCoupon() {
            const couponCode = document.getElementById('couponCode').value.trim().toUpperCase();
            const couponMessage = document.getElementById('couponMessage');
            
            if (couponCode === 'ECO10' || couponCode === 'VERDE15') {
                couponMessage.style.display = 'block';
                couponMessage.className = 'text-success small mt-1';
                couponMessage.innerHTML = '<i class="bi bi-check-circle me-1"></i>Cupón aplicado correctamente';
                // Aquí podrías actualizar el descuento adicional
                updateCartTotals();
            } else if (couponCode !== '') {
                couponMessage.style.display = 'block';
                couponMessage.className = 'text-danger small mt-1';
                couponMessage.innerHTML = '<i class="bi bi-x-circle me-1"></i>Cupón no válido';
            }
        }        // Función para proceder al pago
        function proceedToPayment() {
            if (Object.keys(productPrices).length > 0) {
                // Deshabilitar el botón temporalmente
                const paymentButton = event.target;
                const originalText = paymentButton.innerHTML;
                paymentButton.disabled = true;
                paymentButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
                
                // Mostrar modal de confirmación
                showCartConfirmationModal();
                
                // Simular procesamiento y redirección
                setTimeout(() => {
                    paymentButton.disabled = false;
                    paymentButton.innerHTML = originalText;
                    window.location.href = '/client/pago';
                }, 3000);
            } else {
                alert('Tu carrito está vacío. Agrega productos antes de proceder al pago.');
            }
        }

        // Función para vaciar carrito
        function clearCart() {
            if (confirm('¿Estás seguro de que deseas vaciar todo el carrito?')) {
                showEmptyCart();
            }
        }

        // Función para mostrar carrito vacío
        function showEmptyCart() {
            const cartBody = document.querySelector('.card-body.p-0');
            cartBody.innerHTML = `
                <div class="text-center p-5">
                    <i class="bi bi-cart-x display-1 text-muted mb-3"></i>
                    <h4 class="text-muted">Tu carrito está vacío</h4>
                    <p class="text-muted mb-4">Explora nuestros productos eco-amigables y encuentra lo que necesitas.</p>
                    <a href="/client/catalogo" class="btn btn-success">
                        <i class="bi bi-shop me-2"></i>Ir al Catálogo
                    </a>
                </div>
            `;
            
            // Limpiar totales
            document.getElementById('cartSubtotal').textContent = '$0.00';
            document.getElementById('cartTotal').textContent = '$0.00';
        }

        // Función para mostrar modal de confirmación del carrito
        function showCartConfirmationModal() {
            const modal = new bootstrap.Modal(document.getElementById('cartConfirmationModal'), {
                backdrop: 'static',
                keyboard: false
            });
            modal.show();
            
            // Iniciar countdown
            let countdown = 5;
            const countdownElement = document.getElementById('countdown');
            const progressBar = document.getElementById('redirectProgress');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                progressBar.style.width = ((5 - countdown) / 5 * 100) + '%';
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
        }

        // Permitir entrada manual en campos de cantidad
        document.addEventListener('DOMContentLoaded', function() {
            for (let productId in productPrices) {
                const quantityInput = document.getElementById(`quantity${productId}`);
                if (quantityInput) {
                    quantityInput.addEventListener('input', function() {
                        let value = parseInt(this.value);
                        if (isNaN(value) || value < 1) {
                            value = 1;
                            this.value = value;
                        }
                        updateSubtotal(productId, value);
                        updateCartTotals();
                    });
                }
            }
        });
    </script>
</body>
</html>
